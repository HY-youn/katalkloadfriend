<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카카오톡 친구목록</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .friend-list {
            margin: 20px 0;
        }
        .friend-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 8px 16px;
            background-color: #FEE500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: red;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>카카오톡 친구목록</h1>
        <div id="loginStatus"></div>
        <button id="friendsBtn" onclick="getFriendList()">친구목록 불러오기</button>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="friendList" class="friend-list"></div>
        <div class="pagination">
            <button id="prevBtn" onclick="previousPage()" disabled>이전</button>
            <span id="pageInfo"></span>
            <button id="nextBtn" onclick="nextPage()" disabled>다음</button>
        </div>
    </div>

    <script>
        // 전역 변수 설정
        let currentPage = 1;
        const itemsPerPage = 100;
        let totalItems = 0;
        let friendsData = [];
        let accessToken = '';

        // 에러 처리 함수
        function handleError(error) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = `오류가 발생했습니다: ${error.message}`;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // URL에서 코드 파라미터 추출
        function getUrlParameter(name) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            } catch (error) {
                handleError(error);
                return null;
            }
        }

        // 액세스 토큰 획득
        async function getAccessToken(code) {
            try {
                const response = await fetch('https://kauth.kakao.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: '069bd62145d0e4923041dbea4fb7984b', // 여기에 클라이언트 ID를 입력하세요
                        redirect_uri: 'https://katalkloadfriend.vercel.app/', // 여기에 리다이렉트 URI를 입력하세요
                        code: code,
                    })
                });
                
                if (!response.ok) throw new Error('토큰 획득 실패');
                
                const data = await response.json();
                accessToken = data.access_token;
                document.getElementById('loginStatus').textContent = '로그인 성공!';
                return data.access_token;
            } catch (error) {
                handleError(error);
                return null;
            }
        }

        // 친구 목록 가져오기
        async function getFriendList() {
            try {
                if (!accessToken) {
                    throw new Error('로그인이 필요합니다');
                }

                const response = await fetch('https://kapi.kakao.com/v1/api/talk/friends', {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    }
                });

                if (!response.ok) throw new Error('친구 목록 가져오기 실패');

                const data = await response.json();
                friendsData = data.elements.map((friend, index) => ({
                    id: index + 1, // Primary key
                    kakaoId: friend.uuid, // 카카오톡 ID
                    newId: '', // 변경할 ID (초기값 빈 문자열)
                    nickname: friend.profile_nickname
                }));

                totalItems = friendsData.length;
                displayFriends();
                updatePaginationButtons();
            } catch (error) {
                handleError(error);
            }
        }

        // 친구 목록 표시
        function displayFriends() {
            try {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const currentFriends = friendsData.slice(startIndex, endIndex);

                const friendListDiv = document.getElementById('friendList');
                friendListDiv.innerHTML = '';

                currentFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-item';
                    friendDiv.innerHTML = `
                        <span>ID: ${friend.id}</span>
                        <span>카카오ID: ${friend.kakaoId}</span>
                        <input type="text" 
                               placeholder="변경할 ID" 
                               value="${friend.newId}"
                               onchange="updateNewId(${friend.id}, this.value)">
                        <span>${friend.nickname}</span>
                    `;
                    friendListDiv.appendChild(friendDiv);
                });

                document.getElementById('pageInfo').textContent = 
                    `${currentPage} / ${Math.ceil(totalItems / itemsPerPage)} 페이지`;
            } catch (error) {
                handleError(error);
            }
        }

        // 새 ID 업데이트
        function updateNewId(id, value) {
            try {
                const friend = friendsData.find(f => f.id === id);
                if (friend) {
                    friend.newId = value;
                }
            } catch (error) {
                handleError(error);
            }
        }

        // 페이지네이션 버튼 상태 업데이트
        function updatePaginationButtons() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // 이전 페이지
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayFriends();
                updatePaginationButtons();
            }
        }

        // 다음 페이지
        function nextPage() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayFriends();
                updatePaginationButtons();
            }
        }

        // 초기화
        window.onload = async function() {
            const code = getUrlParameter('code');
            if (code) {
                await getAccessToken(code);
            }
        };
    </script>
</body>
</html>